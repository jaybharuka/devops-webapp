stages:
  - build
  - deploy

variables:
  GIT_STRATEGY: clone

# Build job
build:
  stage: build
  image: alpine:latest
  script:
    - echo "Building project..."
    - ls -la
    - echo "Build Successful ðŸš€"
  artifacts:
    paths:
      - index.html
    expire_in: 1 hour
  only:
    - main

# Deploy to Netlify
deploy_netlify:
  stage: deploy
  image: node:18-alpine
  script:
    - echo "Installing Netlify CLI..."
    - npm install -g netlify-cli
    - echo "Deploying to Netlify..."
    - mkdir -p public
    - cp index.html public/
    - netlify deploy --prod --dir=public --auth=$NETLIFY_AUTH_TOKEN --site=$NETLIFY_SITE_ID
    - echo "Deployment to Netlify Successful ðŸš€"
  only:
    - main
  needs:
    - build

# Optional: Notify on success
notify_success:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - |
      if [ -n "$SLACK_WEBHOOK" ]; then
        curl -X POST -H "Content-type: application/json" \
        --data '{"text":"âœ… GitLab CI/CD Build & Deploy to Netlify Successful!"}' \
        $SLACK_WEBHOOK
      else
        echo "SLACK_WEBHOOK not configured, skipping notification"
      fi
  only:
    - main
  when: on_success
  allow_failure: true
